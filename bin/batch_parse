#!/bin/bash
#

# POSIX...
OPTIND=1

show_help() {
  echo Usage: `basename $0` "-i <in_folder>"
}

if [ $# -ne 2 ]
then
  show_help
  exit 1
fi

EXE="sf2_parser"
DATADIR=""
OUTDIR=""


while getopts "h?i:" opt; do
  case "$opt" in
    h|\?)
        show_help
        exit 0
        ;;
    i)  DATADIR=$OPTARG
        ;;
  esac
done
set -- $args
shift $((OPTIND-1))
[ "$1" = "--" ] && shift

# Make subdir for parsed superframes
mkdir -p ${DATADIR%/}/parsed

superframes=(${DATADIR%/}/*.pgm)
numfiles=${#superframes[@]}
max_index=$(( numfiles - 1 ))

process_batch(){
  frame=$(basename $1  | sed 's/\.[^\.]*$//' | sed 's/m//')
  $3 $1
  mv small_img.pgm ${2%/}/parsed/$frame.pgm
}

for ((i = 0; i < max_index; i++))
do
  echo "Processing frame (${superframes[i]}) $((i+1)) of $max_index"
   process_batch ${superframes[i]} $DATADIR $EXE
done
